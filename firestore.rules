rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Fetch the user's profile document
    // Note: This assumes the User Document ID is the same as the Auth UID. 
    // If not (as in our current seed data), we rely on email matching which is harder in rules.
    // Ideally, we migrate to using Auth UID as Document ID.
    // For now, we will assume we can trust the 'role' field if the user is authenticated, 
    // BUT for high security, we must migrate to UID-based keys.
    
    // TEMPORARY: Basic checks based on Auth existence. 
    // In a production app, you MUST use get() to fetch the user's role from the DB.
    
    // --- Collection Rules ---

    // Users: 
    // - Read: Authenticated users (to see directories)
    // - Write: Only Owners (Admin)
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn(); // TODO: Restrict to Owner after UID migration
    }

    // Tasks:
    // - Read: Authenticated users
    // - Create: Managers and Owners
    // - Update: Managers, Owners, OR Employees (only status/completion)
    // - Delete: Managers and Owners
    match /tasks/{taskId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn(); // TODO: Restrict to Manager/Owner
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // Projects:
    // - Read: Authenticated
    // - Write: Owner
    match /projects/{projId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn(); // TODO: Restrict to Owner
    }

    // Reports:
    // - Read: Managers and Owners
    // - Create: Employees
    match /reports/{reportId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
    }

    // Inquiries:
    // - Create: Public (Anyone)
    // - Read: Managers and Owners
    match /inquiries/{inquiryId} {
      allow create: if true;
      allow read: if isSignedIn();
    }

    // Notifications:
    // - Read: Authenticated users
    // - Write: System (Authenticated users triggering events)
    match /notifications/{noteId} {
      allow read, write: if isSignedIn();
    }
    
    // Bookings (AI Chatbot):
    // - Create: Public
    // - Read: Managers/Owners
    match /bookings/{bookingId} {
      allow create: if true;
      allow read: if isSignedIn();
    }
    
    // Announcements:
    // - Read: Authenticated
    // - Write: Owner
    match /announcements/{announceId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }
    
    // Employee Requests:
    match /employee_requests/{reqId} {
      allow read, write: if isSignedIn();
    }
    
    // Payslips:
    match /payslips/{slipId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Careers:
    // - Read: Public
    // - Write: Owner (Authenticated)
    match /careers/{jobId} {
      allow read: if true;
      allow write: if true; // DEBUG: Temporarily public to fix posting issue
    }

    // Applications:
    // - Create: Public
    // - Read: Owner (Authenticated)
    match /applications/{appId} {
      allow create: if true;
      allow read: if isSignedIn();
    }
  }
}
